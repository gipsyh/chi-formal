#lang ivy1.7

include basic

type msg_type_t = { req_read_not_share_dirty_t,
                        req_read_no_snp_t,
                        req_read_unique_t,
                        data_todo_t,
                        snp_read_not_share_dirty_fwd_t
                    }

module msg_t = {
    individual src_id: nid_t
    individual tgt_id: nid_t
    individual txn_id: txn_idx_t
    individual addr: addr_t
    individual opcode: msg_type_t
    individual dbid: txn_idx_t
    individual return_nid: nid_t
    individual return_txn_id: txn_idx_t
    individual home_nid: nid_t
    individual data: data_t
    # TODO: replace to resp
    individual share: bool
}

module slots_t(obj, idx) = {
    relation in_use(I: idx)
    instance m(I: idx): obj 

    after init {
        in_use(I) := false
    }

    action new returns(r: idx) = {
        assume ~in_use(r);
        in_use(r) := true;
    }

    action free(f: idx) = {
        assert in_use(f);
        in_use(f) := false;
    }
}

instance msg: slots_t(msg_t, midx_t)
